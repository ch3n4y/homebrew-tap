name: Auto Update EasyTier

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new releases
        id: check
        run: |
          # Get latest release version (including pre-releases)
          LATEST_VERSION=$(curl -s https://api.github.com/repos/EasyTier/EasyTier/releases | \
            jq -r '.[0].tag_name' | sed 's/^v//')
          CURRENT_VERSION=$(grep 'version "' Formula/easytier.rb | head -1 | \
            sed 's/.*version "\(.*\)"/\1/')

          echo "Latest version: $LATEST_VERSION"
          echo "Current version: $CURRENT_VERSION"

          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
            echo "new_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Download and calculate SHA256
        if: steps.check.outputs.has_update == 'true'
        id: sha256
        run: |
          VERSION=${{ steps.check.outputs.new_version }}

          echo "Downloading files for version $VERSION..."

          # Download formula files in parallel
          curl -sL "https://github.com/EasyTier/EasyTier/releases/download/v${VERSION}/easytier-macos-aarch64-v${VERSION}.zip" \
            -o arm64.zip &
          curl -sL "https://github.com/EasyTier/EasyTier/releases/download/v${VERSION}/easytier-macos-x86_64-v${VERSION}.zip" \
            -o x64.zip &

          # Download cask files in parallel
          curl -sL "https://github.com/EasyTier/EasyTier/releases/download/v${VERSION}/easytier-gui_${VERSION}_aarch64.dmg" \
            -o gui-arm64.dmg &
          curl -sL "https://github.com/EasyTier/EasyTier/releases/download/v${VERSION}/easytier-gui_${VERSION}_x64.dmg" \
            -o gui-x64.dmg &

          # Wait for all downloads to complete
          wait

          # Calculate SHA256 hashes
          FORMULA_ARM64_SHA=$(shasum -a 256 arm64.zip | awk '{print $1}')
          FORMULA_X64_SHA=$(shasum -a 256 x64.zip | awk '{print $1}')
          CASK_ARM64_SHA=$(shasum -a 256 gui-arm64.dmg | awk '{print $1}')
          CASK_X64_SHA=$(shasum -a 256 gui-x64.dmg | awk '{print $1}')

          echo "Formula ARM64 SHA256: $FORMULA_ARM64_SHA"
          echo "Formula x64 SHA256: $FORMULA_X64_SHA"
          echo "Cask ARM64 SHA256: $CASK_ARM64_SHA"
          echo "Cask x64 SHA256: $CASK_X64_SHA"

          # Export to GitHub outputs
          echo "formula_arm64_sha=$FORMULA_ARM64_SHA" >> $GITHUB_OUTPUT
          echo "formula_x64_sha=$FORMULA_X64_SHA" >> $GITHUB_OUTPUT
          echo "cask_arm64_sha=$CASK_ARM64_SHA" >> $GITHUB_OUTPUT
          echo "cask_x64_sha=$CASK_X64_SHA" >> $GITHUB_OUTPUT

      - name: Update Formula
        if: steps.check.outputs.has_update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.new_version }}
          ARM64_SHA=${{ steps.sha256.outputs.formula_arm64_sha }}
          X64_SHA=${{ steps.sha256.outputs.formula_x64_sha }}

          echo "Updating Formula/easytier.rb to version $VERSION..."

          # Update version
          sed -i '' "s/version \".*\"/version \"$VERSION\"/" Formula/easytier.rb

          # Update ARM64 URL and SHA256
          sed -i '' "s|easytier-macos-aarch64-v.*\.zip|easytier-macos-aarch64-v$VERSION.zip|" Formula/easytier.rb
          sed -i '' "/if Hardware::CPU.arm?/,/sha256/ s/sha256 \".*\"/sha256 \"$ARM64_SHA\"/" Formula/easytier.rb

          # Update x86_64 URL and SHA256
          sed -i '' "s|easytier-macos-x86_64-v.*\.zip|easytier-macos-x86_64-v$VERSION.zip|" Formula/easytier.rb
          sed -i '' "/else/,/end/ s/sha256 \".*\"/sha256 \"$X64_SHA\"/" Formula/easytier.rb

          echo "Formula updated successfully"

      - name: Update Cask
        if: steps.check.outputs.has_update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.new_version }}
          ARM64_SHA=${{ steps.sha256.outputs.cask_arm64_sha }}
          X64_SHA=${{ steps.sha256.outputs.cask_x64_sha }}

          echo "Updating Casks/easytier-gui.rb to version $VERSION..."

          # Update version
          sed -i '' "s/version \".*\"/version \"$VERSION\"/" Casks/easytier-gui.rb

          # Update SHA256 hashes (new format: sha256 arm: "...", intel: "...")
          sed -i '' "s/sha256 arm:   \".*\",/sha256 arm:   \"$ARM64_SHA\",/" Casks/easytier-gui.rb
          sed -i '' "s/intel: \".*\"/intel: \"$X64_SHA\"/" Casks/easytier-gui.rb

          echo "Cask updated successfully"

      - name: Verify changes
        if: steps.check.outputs.has_update == 'true'
        run: |
          echo "=== Formula changes ==="
          git diff Formula/easytier.rb
          echo ""
          echo "=== Cask changes ==="
          git diff Casks/easytier-gui.rb

      - name: Commit and push changes
        if: steps.check.outputs.has_update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.new_version }}

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Formula/easytier.rb Casks/easytier-gui.rb
          git commit -m "chore: auto update easytier to v${VERSION}" \
            -m "- Update easytier formula to v${VERSION}" \
            -m "- Update easytier-gui cask to v${VERSION}" \
            -m "- Update SHA256 hashes for all architectures"

          git push

      - name: Create summary
        if: steps.check.outputs.has_update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.new_version }}
          echo "## ✅ Successfully updated to v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated files:" >> $GITHUB_STEP_SUMMARY
          echo "- Formula/easytier.rb" >> $GITHUB_STEP_SUMMARY
          echo "- Casks/easytier-gui.rb" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SHA256 Hashes:" >> $GITHUB_STEP_SUMMARY
          echo "**Formula:**" >> $GITHUB_STEP_SUMMARY
          echo "- ARM64: \`${{ steps.sha256.outputs.formula_arm64_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- x64: \`${{ steps.sha256.outputs.formula_x64_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cask:**" >> $GITHUB_STEP_SUMMARY
          echo "- ARM64: \`${{ steps.sha256.outputs.cask_arm64_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- x64: \`${{ steps.sha256.outputs.cask_x64_sha }}\`" >> $GITHUB_STEP_SUMMARY

      - name: No update needed
        if: steps.check.outputs.has_update == 'false'
        run: |
          echo "## ℹ️ No update needed" >> $GITHUB_STEP_SUMMARY
          echo "Already at the latest version" >> $GITHUB_STEP_SUMMARY
