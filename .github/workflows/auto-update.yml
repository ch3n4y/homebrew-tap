name: Auto Update EasyTier

on:
  schedule:
    # Run every day at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new releases
        id: check
        run: |
          # Get latest release version
          LATEST_VERSION=$(curl -s https://api.github.com/repos/EasyTier/EasyTier/releases | jq -r '.[0].tag_name' | sed 's/^v//')
          CURRENT_VERSION=$(grep 'version "' Formula/easytier.rb | head -1 | sed 's/.*version "\(.*\)"/\1/')

          echo "Latest version: $LATEST_VERSION"
          echo "Current version: $CURRENT_VERSION"

          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
            echo "new_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "has_update=true" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Download and calculate SHA256
        if: steps.check.outputs.has_update == 'true'
        id: sha256
        run: |
          VERSION=${{ steps.check.outputs.new_version }}

          # Download formula files
          curl -sL "https://github.com/EasyTier/EasyTier/releases/download/v${VERSION}/easytier-macos-aarch64-v${VERSION}.zip" -o arm64.zip
          curl -sL "https://github.com/EasyTier/EasyTier/releases/download/v${VERSION}/easytier-macos-x86_64-v${VERSION}.zip" -o x64.zip

          # Download cask files
          curl -sL "https://github.com/EasyTier/EasyTier/releases/download/v${VERSION}/easytier-gui_${VERSION}_aarch64.dmg" -o gui-arm64.dmg
          curl -sL "https://github.com/EasyTier/EasyTier/releases/download/v${VERSION}/easytier-gui_${VERSION}_x64.dmg" -o gui-x64.dmg

          # Calculate SHA256
          FORMULA_ARM64_SHA=$(shasum -a 256 arm64.zip | awk '{print $1}')
          FORMULA_X64_SHA=$(shasum -a 256 x64.zip | awk '{print $1}')
          CASK_ARM64_SHA=$(shasum -a 256 gui-arm64.dmg | awk '{print $1}')
          CASK_X64_SHA=$(shasum -a 256 gui-x64.dmg | awk '{print $1}')

          echo "formula_arm64_sha=$FORMULA_ARM64_SHA" >> $GITHUB_OUTPUT
          echo "formula_x64_sha=$FORMULA_X64_SHA" >> $GITHUB_OUTPUT
          echo "cask_arm64_sha=$CASK_ARM64_SHA" >> $GITHUB_OUTPUT
          echo "cask_x64_sha=$CASK_X64_SHA" >> $GITHUB_OUTPUT

      - name: Update Formula
        if: steps.check.outputs.has_update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.new_version }}
          FORMULA_ARM64_SHA=${{ steps.sha256.outputs.formula_arm64_sha }}
          FORMULA_X64_SHA=${{ steps.sha256.outputs.formula_x64_sha }}

          # Update version
          sed -i '' "s/version \".*\"/version \"$VERSION\"/" Formula/easytier.rb

          # Update ARM64 URL and SHA256
          sed -i '' "s|easytier-macos-aarch64-v.*\.zip|easytier-macos-aarch64-v$VERSION.zip|" Formula/easytier.rb
          sed -i '' "/if Hardware::CPU.arm?/,/sha256/ s/sha256 \".*\"/sha256 \"$FORMULA_ARM64_SHA\"/" Formula/easytier.rb

          # Update x86_64 URL and SHA256
          sed -i '' "s|easytier-macos-x86_64-v.*\.zip|easytier-macos-x86_64-v$VERSION.zip|" Formula/easytier.rb
          sed -i '' "/else/,/end/ s/sha256 \".*\"/sha256 \"$FORMULA_X64_SHA\"/" Formula/easytier.rb

      - name: Update Cask
        if: steps.check.outputs.has_update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.new_version }}
          CASK_ARM64_SHA=${{ steps.sha256.outputs.cask_arm64_sha }}
          CASK_X64_SHA=${{ steps.sha256.outputs.cask_x64_sha }}

          # Update version
          sed -i '' "s/version \".*\"/version \"$VERSION\"/" Casks/easytier-gui.rb

          # Update ARM64 SHA256
          sed -i '' "/on_arm do/,/end/ s/sha256 \".*\"/sha256 \"$CASK_ARM64_SHA\"/" Casks/easytier-gui.rb

          # Update x86_64 SHA256
          sed -i '' "/on_intel do/,/end/ s/sha256 \".*\"/sha256 \"$CASK_X64_SHA\"/" Casks/easytier-gui.rb

      - name: Commit and push changes
        if: steps.check.outputs.has_update == 'true'
        run: |
          VERSION=${{ steps.check.outputs.new_version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/easytier.rb Casks/easytier-gui.rb
          git commit -m "Auto update easytier to v$VERSION"
          git push
